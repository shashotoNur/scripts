#!/bin/bash

# =================================================================
#  Interactive Line Navigator & Executor
# =================================================================

# --- Configuration ---
START_TIME=$(date +%s)
INPUT_FILE="$1"
KITTY_SOCKET="/tmp/kitty_remote_$START_TIME"

# --- Color Definitions (ANSII Escape Sequence) ---
RED='\033[0;31m'        # C
GREEN='\033[0;32m'      # O
YELLOW='\033[0;33m'     # L
BLUE='\033[0;34m'       # O
CYAN='\033[0;36m'       # R
NC='\033[0m'            # No Color

# --- Utility Functions ---

cleanup() {
    END_TIME=$(date +%s)
    ELAPSED_TIME=$((END_TIME - START_TIME))

    echo -e "\n"

    # Kitty instance
    if [[ "$HAS_KITTY" == true ]]; then
        read -r -s -n 1 -p "Terminate Kitty [y/N]?" choice
        if [[ "$choice" =~ ^[yY]$ ]]; then
            kitty @ --to "unix:$KITTY_SOCKET" send-text "exit\r" 2>/dev/null
            echo -e "\n${CYAN}Kitty has been terminated...${NC}"
        fi
        rm -f "$KITTY_SOCKET"
    fi

    echo -e "\n${CYAN}===================================="
    echo -e "Total time elapsed: ${YELLOW}${ELAPSED_TIME} seconds.${NC}"
    echo -e "${CYAN}Exiting...${NC}"
    exit 0
}

draw_line() {
    local idx=$1
    local content="${LINES[$idx]}"

    printf "\r\r\033[2K" # VT100: \033[2K (Clear line), \r (Carriage return) 
    printf "${BLUE}[%d/%d]${NC} > %s" "$((idx + 1))" "$TOTAL_LINES" "$content"
}

# --- Requirements & Capabilities Check ---

if command -v wl-copy &> /dev/null; then
    CLIP_CMD="wl-copy"                      # For Wayland session
    HAS_CLIPBOARD=true
elif command -v xclip &> /dev/null; then
    CLIP_CMD="xclip -selection clipboard"   # For X11 session
    HAS_CLIPBOARD=true
else
    HAS_CLIPBOARD=false
    echo -e "${YELLOW}Warning:${NC} Neither 'wl-copy' nor 'xclip' found. Copying disabled."
fi

if [[ -z "$INPUT_FILE" || ! -f "$INPUT_FILE" ]]; then
    echo -e "${RED}Error:${NC} Usage: $0 <file>"
    exit 1
fi

if command -v kitty &> /dev/null; then
    HAS_KITTY=true
else
    HAS_KITTY=false
fi

# --- Initialization ---
mapfile -t LINES < "$INPUT_FILE"
TOTAL_LINES=${#LINES[@]}

if [[ $TOTAL_LINES -eq 0 ]]; then
    echo -e "${RED}Error:${NC} Input file is empty."
    exit 1
fi

CURRENT_LINE=0
FIRST_LINE="${LINES[0]}"

# Launch Kitty only if available
if [[ "$HAS_KITTY" == true ]]; then
    (
        kitty --listen-on "unix:$KITTY_SOCKET" --session - <<EOF
launch --title="Kitty_Instance_$START_TIME" bash
EOF
    ) >/dev/null 2>&1 </dev/null &
    sleep 0.5 # Wait fo kitty to initialize
fi

# Ensure cleanup even on error
trap cleanup EXIT

# --- Header ---
CLIP_NAME=$([[ "$HAS_CLIPBOARD" == true ]] && echo "$CLIP_CMD" | awk '{print $1}' || echo "None")
echo -e "${BLUE}Line Navigator & Executor${NC}"
echo -e "[Kitty: $( [[ "$HAS_KITTY" == true ]] && echo -e "${GREEN}ON${NC}" || echo -e "${RED}OFF${NC}" )\
 | Clip: ${CYAN}$CLIP_NAME${NC}]"
echo -n -e "${YELLOW}Controls:${NC} [↑/↓] Nav | [q] Quit"
if [[ "$HAS_KITTY" == true ]]; then
    echo -n -e " | [Enter] Exec | [→] Write"
fi
if [[ "$HAS_CLIPBOARD" == true ]]; then
    echo -e " | [c] Copy"
else
    echo ""
fi
echo -e "${CYAN}====================================${NC}"

# --- Main Event Loop ---
while true; do
    # `sleep` command is mutating the first element; Reassign it
    LINES[0]="$FIRST_LINE"

    draw_line "$CURRENT_LINE"

    IFS= read -rsn1 key

    if [[ $key == $'\e' ]]; then
        read -rsn2 -t 0.1 next_chars
        case "$next_chars" in
            '[A') ((CURRENT_LINE > 0)) && ((CURRENT_LINE--)) ;;                     # Up Arrow
            '[B') ((CURRENT_LINE < TOTAL_LINES - 1)) && ((CURRENT_LINE++)) ;;       # Down Arrow
            '[C') 
                if [[ "$HAS_KITTY" == true ]]; then
                    kitty @ --to "unix:$KITTY_SOCKET" send-text "${LINES[$CURRENT_LINE]}"
                    printf " ${GREEN}(Staged!)${NC}" && sleep 0.4
                fi
                ;;                                                                  # Right Arrow
        esac
    elif [[ -z "$key" ]]; then
        if [[ "$HAS_KITTY" == true ]]; then
            # \r acts as Enter => executes the line
            kitty @ --to "unix:$KITTY_SOCKET" send-text "${LINES[$CURRENT_LINE]}\r"
            printf " ${GREEN}(Executed!)${NC}" && sleep 0.4

            # Go to next line after execution
            ((CURRENT_LINE < TOTAL_LINES - 1)) && ((CURRENT_LINE++))
        fi
    fi

    case "$key" in
        c|C)
            if [[ "$HAS_CLIPBOARD" == true ]]; then
                echo -n "${LINES[$CURRENT_LINE]}" | $CLIP_CMD
                printf " ${GREEN}(Copied!)${NC}" && sleep 0.4
            fi
            ;;
        q|Q)
            break
            ;;
    esac
done