#!/usr/bin/env bash

shopt -s nullglob

DIR="${1:-.}"
KEEP_DIR="$DIR/keep"
REMOVE_DIR="$DIR/remove"
RECORD_FILE="$(mktemp)"

declare -A decisions
declare -a files

files=("$DIR"/*.{jpg,jpeg,png,gif,bmp,heic,webp,mp4,mkv,webm,avi,mov,flv})

if [ ${#files[@]} -eq 0 ]; then
  echo "No media files found."
  exit 1
fi

index=0

while [ $index -lt ${#files[@]} ]; do
  clear
  file="${files[$index]}"

  if file --mime-type "$file" | grep -qE 'video|audio'; then
    mpv --no-config --vo=kitty --quiet --really-quiet --loop-file=inf "$file"
  else
    chafa --size=120x30 "$file"
  fi

  choice=$(printf "keep\nremove\nskip\nundo" | fzf --height=5% --prompt="Action: ")

  case "$choice" in
    keep)
      decisions["$file"]="keep"
      ((index++))
      ;;
    remove)
      decisions["$file"]="remove"
      ((index++))
      ;;
    skip)
      ((index++))
      ;;
    undo)
      if (( index > 0 )); then
        ((index--))
        unset 'decisions["${files[$index]}"]'
      fi
      ;;
    *)
      echo "Exiting..."
      break
      ;;
  esac
done

mkdir -p "$KEEP_DIR" "$REMOVE_DIR"

for file in "${!decisions[@]}"; do
  case "${decisions[$file]}" in
    keep) mv -n "$file" "$KEEP_DIR/" ;;
    remove) mv -n "$file" "$REMOVE_DIR/" ;;
  esac
done

clear
echo "--------------------------------------------------------"
echo "Summary of operations:"
echo "  Kept: $(find "$KEEP_DIR" -type f | wc -l) files"
echo "  Removed: $(find "$REMOVE_DIR" -type f | wc -l) files"
echo "  Skipped: $(( ${#files[@]} - ${#decisions[@]} )) files"
